<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>Neal's Blog</title><link>https://blog.hellolinux.cc/</link><description>分享技术，记录生活!</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>pengshp3@outlook.com (pengshp)</managingEditor><webMaster>pengshp3@outlook.com (pengshp)</webMaster><copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright><lastBuildDate>Mon, 25 Apr 2022 20:37:46 +0800</lastBuildDate><atom:link href="https://blog.hellolinux.cc/index.xml" rel="self" type="application/rss+xml"/><item><title>Arch Linux设置rofi</title><link>https://blog.hellolinux.cc/2022/arch-rofi-setup/</link><pubDate>Mon, 25 Apr 2022 20:37:46 +0800</pubDate><author><name>Neal</name><uri>https://blog.hellolinux.cc</uri><email>pengshp3@outlook.com</email></author><guid>https://blog.hellolinux.cc/2022/arch-rofi-setup/</guid><description><![CDATA[<p><a href="https://github.com/lbonn/rofi" target="_blank" rel="noopener noreffer">rofi</a> : A window switcher, run dialog and dmenu replacement. 简单说就相当于我们使用的<code>utools</code>, 可以启动应用，搜索文件，搜索emoji,执行命令等。但utools在Arch Linux的KDE Plasma桌面环境的兼容性不好，于是找到了替代品rofi.试了一下，效果很不错，分享一下自己的配置。</p>
<p>我所使用的窗口管理器是<code>wayland</code>,所以安装该环境下的兼容版本。</p>
<p>Rofi支持下面的模式（Modes）</p>
<ul>
<li><strong>run</strong>: launch applications from $PATH, with option to launch in terminal.</li>
<li><strong>drun</strong>: launch applications based on desktop files. It tries to be compliant to the XDG standard.</li>
<li><strong>window</strong>: Switch between windows on an EWMH compatible window manager.</li>
<li><strong>ssh</strong>: Connect to a remote host via ssh.</li>
<li><strong>filebrowser</strong>: A basic file-browser for opening files.</li>
<li><strong>keys</strong>: list internal keybindings.</li>
<li><strong>script</strong>: Write (limited) custom mode using simple scripts.</li>
<li><strong>combi</strong>: Combine multiple modes into one.</li>
</ul>
<p>可以按 <code>Shift+左右方向键</code>切换不同的Modes.</p>
<h3 id="1-安装" class="headerLink">
    <a href="#1-%e5%ae%89%e8%a3%85" class="header-mark"></a>0.1 1. 安装</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 或者使用yay安装</span>
</span></span><span class="line"><span class="cl">~$ sudo pacman -S chaotic-aur/rofi-lbonn-wayland
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># emoji搜索支持</span>
</span></span><span class="line"><span class="cl">~$ sudo pacman -S community/rofi-emoji
</span></span></code></pre></td></tr></table>
</div>
</div><p>要把emoji复制到剪切板，需要安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">~$ sudo pacman -S wl-clipboard
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-配置" class="headerLink">
    <a href="#2-%e9%85%8d%e7%bd%ae" class="header-mark"></a>0.2 2. 配置</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">~$ mkdir -p ~/.config/rofi
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 生成默认配置</span>
</span></span><span class="line"><span class="cl">~$ rofi -dump-config &gt; ~/.config/rofi/config.rasi
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于我的KDE桌面的主题是Nordic,所以rofi也安装这个主题，比较搭配。安装<a href="https://github.com/undiabler/nord-rofi-theme" target="_blank" rel="noopener noreffer">Nordic主题</a>，下载<code>nord.rasi</code>文件放到<code>~/.config/rofi/config.rasi</code>下，修改配置文件引用该主题，也可添加自定义的设置,下面是我的配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">~$ vim ~/.config/rofi/config.rasi
</span></span><span class="line"><span class="cl">/** Basic config file **/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">configuration <span class="o">{</span>
</span></span><span class="line"><span class="cl">    modes: <span class="o">[</span>combi<span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    modi: <span class="s2">&#34;drun,run,filebrowser,emoji,ssh,combi&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    font: <span class="s2">&#34;MiSans 20&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    width: 24<span class="p">;</span>
</span></span><span class="line"><span class="cl">    display-ssh:    <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    display-emoji:    <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    display-filebrowser:    <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    display-run:    <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    display-drun:   <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    drun-display-format: <span class="s2">&#34;{icon} {name}&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    display-window: <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    display-combi:  <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    show-icons: true<span class="p">;</span>
</span></span><span class="line"><span class="cl">    //icon-theme: <span class="s2">&#34;Papirus&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    icon-theme: <span class="s2">&#34;Tela circle purple dark&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">//setup theme
</span></span><span class="line"><span class="cl">@theme <span class="s2">&#34;nord&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3-设置全局快捷键" class="headerLink">
    <a href="#3-%e8%ae%be%e7%bd%ae%e5%85%a8%e5%b1%80%e5%bf%ab%e6%8d%b7%e9%94%ae" class="header-mark"></a>0.3 3. 设置全局快捷键</h3><p>在系统<em>设置–&gt; 快捷键 –&gt; 自定义快捷键</em> 设置启动rofi的快捷键，我设置的是<code>Alt+Return</code></p>
<h3 id="4-效果展示" class="headerLink">
    <a href="#4-%e6%95%88%e6%9e%9c%e5%b1%95%e7%a4%ba" class="header-mark"></a>0.4 4. 效果展示</h3><p><figure><a class="lightgallery" href="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/2022-04-25_21-09.png" title="Rofi" data-thumbnail="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/2022-04-25_21-09.png" data-sub-html="<h2>Rofi</h2><p>Rofi</p>">
        
    </a><figcaption class="image-caption">Rofi</figcaption>
    </figure></p>
<h3 id="4-参考" class="headerLink">
    <a href="#4-%e5%8f%82%e8%80%83" class="header-mark"></a>0.5 4. 参考</h3><ol>
<li><a href="https://github.com/lbonn/rofi" target="_blank" rel="noopener noreffer">https://github.com/lbonn/rofi</a></li>
<li><a href="https://github.com/undiabler/nord-rofi-theme" target="_blank" rel="noopener noreffer">https://github.com/undiabler/nord-rofi-theme</a></li>
</ol>]]></description></item><item><title>Linux 环境下部署Apache Tomcat Server</title><link>https://blog.hellolinux.cc/2021/apache-tomcat-setup/</link><pubDate>Thu, 30 Dec 2021 10:47:04 +0800</pubDate><author><name>Neal</name><uri>https://blog.hellolinux.cc</uri><email>pengshp3@outlook.com</email></author><guid>https://blog.hellolinux.cc/2021/apache-tomcat-setup/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/apache-tomcat-1.webp" referrerpolicy="no-referrer">
            </div><p>Tomcat 是 Apache 软件基金会（Apache Software Foundation）的 Jakarta 项目中的一个核心项目，由Apache、Sun 和其他一些公司及个人共同开发而成。由于有了Sun 的参与和支持，最新的 Servlet 和JSP 规范总是能在Tomcat 中得到体现，因为Tomcat 技术先进、性能稳定，而且免费，因而深受Java 爱好者的喜爱并得到了部分软件开发商的认可，成为目前比较流行的 Web 应用服务器。</p>
<h2 id="tomcat结构" class="headerLink">
    <a href="#tomcat%e7%bb%93%e6%9e%84" class="header-mark"></a>1 Tomcat结构</h2><p>Tomcat中最顶层的容器是Server，代表着整个服务器，一个Server可以包含至少一个Service，用于具体提供服务。
Service主要包含两个部分：Connector和Container。</p>
<p>Tomcat 的核心就是这两个组件，他们的作用如下：</p>
<ul>
<li>Connector用于处理连接相关的事情，并提供Socket与Request和Response相关的转化;</li>
<li>Container用于封装和管理Servlet，以及具体处理Request请求；</li>
</ul>
<h2 id="tomcat服务器搭建" class="headerLink">
    <a href="#tomcat%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%90%ad%e5%bb%ba" class="header-mark"></a>2 Tomcat服务器搭建</h2><p>本次使用<code>JDK11</code>和<code>Tomcat10</code>版本进行部署.</p>
<h3 id="jdk环境安装" class="headerLink">
    <a href="#jdk%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85" class="header-mark"></a>2.1 JDK环境安装</h3><h4 id="下载安装" class="headerLink">
    <a href="#%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85" class="header-mark"></a>2.1.1 下载安装</h4><p><a href="https://www.oracle.com/java/technologies/javase/jdk11-archive-downloads.html" target="_blank" rel="noopener noreffer">Java Archive Downloads - Java SE 11 (oracle.com)</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~$ wget https://download.java.net/java/ga/jdk11/openjdk-11_linux-x64_bin.tar.gz
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">~$ tar -zxf openjdk-11_linux-x64_bin.tar.gz
</span></span><span class="line"><span class="cl">~$ sudo mv jdk-11 /usr/local/jdk
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="配置jdk环境变量" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%aejdk%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" class="header-mark"></a>2.1.2 配置JDK环境变量</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~$ sudo vim /etc/profile.d/jdk.sh
</span></span><span class="line"><span class="cl"><span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/local/jdk
</span></span><span class="line"><span class="cl"><span class="nv">CLASSPATH</span><span class="o">=</span>.:<span class="nv">$JAVA_HOME</span>/lib/dt.jar:<span class="nv">$JAVA_HOME</span>/lib/tools.jar
</span></span><span class="line"><span class="cl"><span class="nv">PATH</span><span class="o">=</span><span class="nv">$JAVA_HOME</span>/bin:<span class="nv">$PATH</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> JAVA_HOME CLASSPATH PATH
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 验证</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@CentOS<span class="o">]</span> ~$ <span class="nb">source</span> /etc/profile
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@CentOS<span class="o">]</span> ~$ java -version
</span></span><span class="line"><span class="cl">openjdk version <span class="s2">&#34;11&#34;</span> 2018-09-25
</span></span><span class="line"><span class="cl">OpenJDK Runtime Environment 18.9 <span class="o">(</span>build 11+28<span class="o">)</span>
</span></span><span class="line"><span class="cl">OpenJDK 64-Bit Server VM 18.9 <span class="o">(</span>build 11+28, mixed mode<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="安装tomcat" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85tomcat" class="header-mark"></a>2.2 安装Tomcat</h3><p><a href="https://tomcat.apache.org/download-10.cgi" target="_blank" rel="noopener noreffer">Apache Tomcat® - Apache Tomcat 10 Software Downloads</a></p>
<p>安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~$ tar -zxf apache-tomcat-10.0.14.tar.gz
</span></span><span class="line"><span class="cl">~$ sudo mv apache-tomcat-10.0.14 /usr/local/tomcat
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="tomcat管理" class="headerLink">
    <a href="#tomcat%e7%ae%a1%e7%90%86" class="header-mark"></a>3 Tomcat管理</h2><h3 id="启动tomcat" class="headerLink">
    <a href="#%e5%90%af%e5%8a%a8tomcat" class="header-mark"></a>3.1 启动Tomcat</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~$ /usr/local/tomcat/bin/startup.sh
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="查看启动日志" class="headerLink">
    <a href="#%e6%9f%a5%e7%9c%8b%e5%90%af%e5%8a%a8%e6%97%a5%e5%bf%97" class="header-mark"></a>3.2 查看启动日志</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~$ tail -f /usr/local/tomcat/logs/catalina.out
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="查看监听端口" class="headerLink">
    <a href="#%e6%9f%a5%e7%9c%8b%e7%9b%91%e5%90%ac%e7%ab%af%e5%8f%a3" class="header-mark"></a>3.3 查看监听端口</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~$ sudo ss -antpl <span class="p">|</span>grep java
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到Tomcat监听了<code>8080,8005</code></p>
<h3 id="开放防火墙端口" class="headerLink">
    <a href="#%e5%bc%80%e6%94%be%e9%98%b2%e7%81%ab%e5%a2%99%e7%ab%af%e5%8f%a3" class="header-mark"></a>3.4 开放防火墙端口</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~$ sudo firewall-cmd --add-port<span class="o">=</span>8080/tcp --permanent
</span></span><span class="line"><span class="cl">~$ sudo firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><p>浏览器访问 <code>http://ip:8080</code>便可以访问测试页面</p>
<h3 id="修改配置文件" class="headerLink">
    <a href="#%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="header-mark"></a>3.5 修改配置文件</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~$ sudo vim /usr/local/tomcat/conf/server.xml
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="停止服务" class="headerLink">
    <a href="#%e5%81%9c%e6%ad%a2%e6%9c%8d%e5%8a%a1" class="header-mark"></a>3.6 停止服务</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~$ /usr/local/tomcat/bin/shutdown.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>JAVA应用的<code>war</code>包放在<code>/usr/local/tomcat/webapps/</code>里，并删除<code>ROOT</code>目录。改变server.xml文件中的server区域</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;Host</span> <span class="na">name=</span><span class="s">&#34;localhost&#34;</span>  <span class="na">appBase=</span><span class="s">&#34;webapps&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="na">unpackWARs=</span><span class="s">&#34;true&#34;</span> <span class="na">autoDeploy=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;Context</span> <span class="na">path=</span><span class="s">&#34;&#34;</span> <span class="na">docBase=</span><span class="s">&#34;hjc&#34;</span> <span class="na">debug=</span><span class="s">&#34;0&#34;</span> <span class="na">privileged=</span><span class="s">&#34;true&#34;</span><span class="nt">/&gt;</span>  #加入此行
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/Host&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Engine&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/Service&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Server&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="重启tomcat" class="headerLink">
    <a href="#%e9%87%8d%e5%90%aftomcat" class="header-mark"></a>3.7 重启Tomcat</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~$ /usr/local/tomcat/bin/shutdown.sh
</span></span><span class="line"><span class="cl">~$ /usr/local/tomcat/bin/startup.sh
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="设置tomcat的环境变量" class="headerLink">
    <a href="#%e8%ae%be%e7%bd%aetomcat%e7%9a%84%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" class="header-mark"></a>3.8 设置Tomcat的环境变量</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ vim /etc/profile.d/tomcat.sh
</span></span><span class="line"><span class="cl"><span class="c1">#TOMCAT</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TOMCAT_HOME</span><span class="o">=</span>/usr/local/tomcat
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$TOMCAT_HOME</span>/bin
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>CentOS设置KVM虚拟化环境</title><link>https://blog.hellolinux.cc/2021/centos-setup-kvm/</link><pubDate>Tue, 21 Dec 2021 23:32:23 +0800</pubDate><author><name>Neal</name><uri>https://blog.hellolinux.cc</uri><email>pengshp3@outlook.com</email></author><guid>https://blog.hellolinux.cc/2021/centos-setup-kvm/</guid><description><![CDATA[<p>Kernel-based Virtual Machine (KVM)是一种集成到Linux的开源的虚拟化解决方案，它是一个内核模块把Linux变成物理虚拟化平台用来运行virtual machines (VMs).下面介绍在CentOS/Rocky Linux8上搭建KVM虚拟化环境。</p>
<h2 id="kvm虚拟化架构图" class="headerLink">
    <a href="#kvm%e8%99%9a%e6%8b%9f%e5%8c%96%e6%9e%b6%e6%9e%84%e5%9b%be" class="header-mark"></a>1 KVM虚拟化架构图</h2><p><figure><a class="lightgallery" href="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/kvm-architecture.png" title="kvm-architecture" data-thumbnail="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/kvm-architecture.png" data-sub-html="<h2>KVM</h2><p>kvm-architecture</p>">
        
    </a><figcaption class="image-caption">KVM</figcaption>
    </figure></p>
<h2 id="验证环境" class="headerLink">
    <a href="#%e9%aa%8c%e8%af%81%e7%8e%af%e5%a2%83" class="header-mark"></a>2 验证环境</h2><h3 id="检查cpu的虚拟化技术" class="headerLink">
    <a href="#%e6%a3%80%e6%9f%a5cpu%e7%9a%84%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8a%80%e6%9c%af" class="header-mark"></a>2.1 检查CPU的虚拟化技术</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Intel CPU</span>
</span></span><span class="line"><span class="cl">grep -e <span class="s1">&#39;vmx&#39;</span> /proc/cpuinfo
</span></span><span class="line"><span class="cl"><span class="c1"># AMD CPU</span>
</span></span><span class="line"><span class="cl">grep -e <span class="s1">&#39;svm&#39;</span> /proc/cpuinfo
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="验证内核的kvm模块是否开启" class="headerLink">
    <a href="#%e9%aa%8c%e8%af%81%e5%86%85%e6%a0%b8%e7%9a%84kvm%e6%a8%a1%e5%9d%97%e6%98%af%e5%90%a6%e5%bc%80%e5%90%af" class="header-mark"></a>2.2 验证内核的KVM模块是否开启</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">lsmod <span class="p">|</span> grep kvm
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="设置cockpit-web管理接口" class="headerLink">
    <a href="#%e8%ae%be%e7%bd%aecockpit-web%e7%ae%a1%e7%90%86%e6%8e%a5%e5%8f%a3" class="header-mark"></a>3 设置cockpit web管理接口</h2><h3 id="安装cockpit" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85cockpit" class="header-mark"></a>3.1 安装cockpit</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dnf install cockpit cockpit-machines
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="设置开机自启" class="headerLink">
    <a href="#%e8%ae%be%e7%bd%ae%e5%bc%80%e6%9c%ba%e8%87%aa%e5%90%af" class="header-mark"></a>3.2 设置开机自启</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> --now cockpit.socket
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="开放防火墙端口" class="headerLink">
    <a href="#%e5%bc%80%e6%94%be%e9%98%b2%e7%81%ab%e5%a2%99%e7%ab%af%e5%8f%a3" class="header-mark"></a>3.3 开放防火墙端口</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">firewall-cmd --add-service<span class="o">=</span>cockpit --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用浏览器访问<code>https://servr_ip:9090</code>端口就能打开web管理界面</p>
<h2 id="设置虚拟化环境" class="headerLink">
    <a href="#%e8%ae%be%e7%bd%ae%e8%99%9a%e6%8b%9f%e5%8c%96%e7%8e%af%e5%a2%83" class="header-mark"></a>4 设置虚拟化环境</h2><h3 id="安装虚拟化模块" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85%e8%99%9a%e6%8b%9f%e5%8c%96%e6%a8%a1%e5%9d%97" class="header-mark"></a>4.1 安装虚拟化模块</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dnf module install virt
</span></span><span class="line"><span class="cl">dnf install virt-install virt-viewer
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="验证驱动" class="headerLink">
    <a href="#%e9%aa%8c%e8%af%81%e9%a9%b1%e5%8a%a8" class="header-mark"></a>4.2 验证驱动</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">virt-host-validate
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="设置服务的开机自启" class="headerLink">
    <a href="#%e8%ae%be%e7%bd%ae%e6%9c%8d%e5%8a%a1%e7%9a%84%e5%bc%80%e6%9c%ba%e8%87%aa%e5%90%af" class="header-mark"></a>4.3 设置服务的开机自启</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> --now  libvirtd.service
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="添加桥接设备" class="headerLink">
    <a href="#%e6%b7%bb%e5%8a%a0%e6%a1%a5%e6%8e%a5%e8%ae%be%e5%a4%87" class="header-mark"></a>4.4 添加桥接设备</h3><p>在cockpit web界面的网络 &ndash;&gt; 添加桥接 &ndash;&gt; 端口选择你的真实网卡</p>
<p>使用命令行添加网桥设备</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 添加一个网桥设备br0</span>
</span></span><span class="line"><span class="cl">ip link add name br0 <span class="nb">type</span> bridge
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启用br0</span>
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> dev br0 up
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加网络端口到到网桥中，要求先将端口设置为混杂模式</span>
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> dev ens33 promisc on
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> dev ens33 up
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> dev ens33 master br0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 显示现存的网桥和关联的端口</span>
</span></span><span class="line"><span class="cl">bridge link show
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>MyCat实现MySQL数据的读写分离</title><link>https://blog.hellolinux.cc/2021/mycat-mariadb-write-read/</link><pubDate>Wed, 04 Aug 2021 18:23:07 +0000</pubDate><author><name>Neal</name><uri>https://blog.hellolinux.cc</uri><email>pengshp3@outlook.com</email></author><guid>https://blog.hellolinux.cc/2021/mycat-mariadb-write-read/</guid><description><![CDATA[<p><figure><a class="lightgallery" href="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/image-20210804225925453.png" title="mycat" data-thumbnail="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/image-20210804225925453.png" data-sub-html="<h2>MyCat</h2><p>mycat</p>">
        
    </a><figcaption class="image-caption">MyCat</figcaption>
    </figure></p>
<p>MyCat是开源社区在阿里cobar基础上使用Java进行二次开发的开源数据库中间件,本文介绍使用 <code>MyCat</code> 实现读写分离.</p>
<h2 id="mycat简介" class="headerLink">
    <a href="#mycat%e7%ae%80%e4%bb%8b" class="header-mark"></a>1 MyCat简介</h2><p>MyCat是开源社区在阿里cobar基础上使用Java进行二次开发的开源数据库中间件；是一个开源的分布式数据库系统，是一个实现了MySQL协议的的Server，前端用户可以把它看作是一个数据库代理，用MySQL客户端工具和命令行访问，而其后端可以用MySQL原生（Native）协议与多个MySQL服务器通信，也可以用JDBC协议与大多数主流数据库服务器通信，其核心功能是分表分库，即将一个大表水平分割为N个小表，存储在后端MySQL服务器里或者其他数据库里。</p>
<p>Mycat发展到目前的版本，已经不是一个单纯的MySQL代理了，它的后端可以支持MySQL、SQL Server、Oracle、DB2、PostgreSQL等主流数据库，也支持MongoDB这种新型NoSQL方式的存储，未来还会支持更多类型的存储。</p>
<p>对于DBA来说，可以这么理解Mycat： Mycat就是MySQL Server，而Mycat后面连接的MySQL Server，就好象是MySQL的存储引擎,如InnoDB，MyISAM等，因此，Mycat本身并不存储数据，数据是在后端的MySQL上存储的，因此数据可靠性以及事务等都是MySQL保证的；</p>
<p>对于架构师来说，可以这么理解Mycat：Mycat是一个<code>强大的数据库中间件</code>，不仅仅可以用作<code>读写分离、以及分表分库、容灾备份</code>，而且可以用于多租户应用开发、云平台基础设施、让你的架构具备很强的适应性和灵活性，借助于即将发布的Mycat智能优化模块，系统的数据访问瓶颈和热点一目了然，根据这些统计分析数据，你可以自动或手工调整后端存储，将不同的表映射到不同存储引擎上，而整个应用的代码一行也不用改变。</p>
<p><a href="http://www.mycat.org.cn/" target="_blank" rel="noopener noreffer">Mycat1.6官网</a></p>
<p><a href="https://www.yuque.com/ccazhw/tuacvk" target="_blank" rel="noopener noreffer">Mycat1权威指南 · 语雀 (yuque.com)</a></p>
<h2 id="mycat作用" class="headerLink">
    <a href="#mycat%e4%bd%9c%e7%94%a8" class="header-mark"></a>2 MyCat作用</h2><ol>
<li>
<p>读写分离</p>
<p><figure><a class="lightgallery" href="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/image-20210804225925453.png" title="mk" data-thumbnail="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/image-20210804225925453.png" data-sub-html="<h2>MyCat-2</h2><p>mk</p>">
        
    </a><figcaption class="image-caption">MyCat-2</figcaption>
    </figure></p>
</li>
<li>
<p>数据分片</p>
<p>垂直拆分（分库）、水平拆分（分表）、垂直+水平拆分（分库分表）</p>
</li>
</ol>
<p><figure><a class="lightgallery" href="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f61991a54ff0478bbe6825f414605291~tplv-k3u1fbpfcp-watermark.image" title="image.png" data-thumbnail="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f61991a54ff0478bbe6825f414605291~tplv-k3u1fbpfcp-watermark.image" data-sub-html="<h2>数据分片</h2><p>image.png</p>">
        
    </a><figcaption class="image-caption">数据分片</figcaption>
    </figure></p>
<ol start="3">
<li>多数据源整合</li>
</ol>
<p><figure><a class="lightgallery" href="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d62be6fd910645d6b5fd0de43129f6e4~tplv-k3u1fbpfcp-watermark.image" title="image.png" data-thumbnail="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d62be6fd910645d6b5fd0de43129f6e4~tplv-k3u1fbpfcp-watermark.image" data-sub-html="<h2>数据整合</h2><p>image.png</p>">
        
    </a><figcaption class="image-caption">数据整合</figcaption>
    </figure></p>
<h2 id="mycat原理" class="headerLink">
    <a href="#mycat%e5%8e%9f%e7%90%86" class="header-mark"></a>3 MyCat原理</h2><p>Mycat 的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的 SQL 语句，首先对 SQL 语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此 SQL 发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。</p>
<h2 id="mycat安装" class="headerLink">
    <a href="#mycat%e5%ae%89%e8%a3%85" class="header-mark"></a>4 MyCat安装</h2><ol>
<li>安装java运行环境JDK</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ sudo wget http://dl.mycat.org.cn/jdk-8u20-linux-x64.tar.gz
</span></span><span class="line"><span class="cl">$ sudo tar -zxf jdk-8u20-linux-x64.tar.gz
</span></span><span class="line"><span class="cl">$ sudo mv jdk1.8.0_20 /usr/local/jdk
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 配置环境变量</span>
</span></span><span class="line"><span class="cl">~$ sudo vim /etc/profile.d/jdk.sh
</span></span><span class="line"><span class="cl"><span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/local/jdk
</span></span><span class="line"><span class="cl"><span class="nv">JRE_HOME</span><span class="o">=</span><span class="nv">$JAVA_HOME</span>/jre
</span></span><span class="line"><span class="cl"><span class="nv">CLASSPATH</span><span class="o">=</span>.:<span class="nv">$JAVA_HOME</span>/lib/dt.jar:<span class="nv">$JAVA_HOME</span>/lib/tools.jar
</span></span><span class="line"><span class="cl"><span class="nv">PATH</span><span class="o">=</span><span class="nv">$JAVA_HOME</span>/bin:<span class="nv">$PATH</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> JAVA_HOME JRE_HOME CLASSPATH PATH
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 验证</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@CentOS<span class="o">]</span> ~$ <span class="nb">source</span> /etc/profile
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@CentOS<span class="o">]</span> ~$ java -version
</span></span><span class="line"><span class="cl">java version <span class="s2">&#34;1.8.0_20&#34;</span>
</span></span><span class="line"><span class="cl">Java<span class="o">(</span>TM<span class="o">)</span> SE Runtime Environment <span class="o">(</span>build 1.8.0_20-b26<span class="o">)</span>
</span></span><span class="line"><span class="cl">Java HotSpot<span class="o">(</span>TM<span class="o">)</span> 64-Bit Server VM <span class="o">(</span>build 25.20-b23, mixed mode<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="mycat安装-1" class="headerLink">
    <a href="#mycat%e5%ae%89%e8%a3%85-1" class="header-mark"></a>5 MyCat安装</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~$ sudo wget http://dl.mycat.org.cn/1.6.7.1/Mycat-server-1.6.7.1-release-20200209222254-linux.tar.gz
</span></span><span class="line"><span class="cl">~$ tar -zxf Mycat-server-1.6.7.1-release-20200209222254-linux.tar.gz -C /usr/local
</span></span><span class="line"><span class="cl">~$ ls /usr/local/mycat
</span></span><span class="line"><span class="cl">bin  catlet  conf  lib  logs  version.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置java路径</span>
</span></span><span class="line"><span class="cl">~$ sudo vim /usr/local/mycat/conf/wrapper.conf
</span></span><span class="line"><span class="cl">wrapper.java.command<span class="o">=</span>/usr/local/jdk/bin/java
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">wrapper.startup.timeout<span class="o">=</span><span class="m">300</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 若启动出错，调整虚拟内存的大小</span>
</span></span><span class="line"><span class="cl">wrapper.java.additional.9<span class="o">=</span>-Xmx2G
</span></span><span class="line"><span class="cl">wrapper.java.additional.10<span class="o">=</span>-Xms512M
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置环境变量</span>
</span></span><span class="line"><span class="cl">~$ sudo vim /etc/profile.d/mycat.sh
</span></span><span class="line"><span class="cl"><span class="nv">MYCAT_HOME</span><span class="o">=</span>/usr/local/mycat
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">~$ <span class="nb">source</span> /etc/profile
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="mycat读写分离架构" class="headerLink">
    <a href="#mycat%e8%af%bb%e5%86%99%e5%88%86%e7%a6%bb%e6%9e%b6%e6%9e%84" class="header-mark"></a>6 MyCat读写分离架构</h2><p><figure><a class="lightgallery" href="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b83bc2375814d509b800ab7a74a6e14~tplv-k3u1fbpfcp-watermark.image" title="mycat" data-thumbnail="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b83bc2375814d509b800ab7a74a6e14~tplv-k3u1fbpfcp-watermark.image" data-sub-html="<h2>MyCat-3</h2><p>mycat</p>">
        
    </a><figcaption class="image-caption">MyCat-3</figcaption>
    </figure></p>
<p>应用直接连接MyCat的逻辑表testdb,MyCat后端连接真实的MySQL数据库实例，并把写数据和读数据分开，减轻单个MySQL实例的压力。</p>
<h2 id="配置读写分离" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae%e8%af%bb%e5%86%99%e5%88%86%e7%a6%bb" class="header-mark"></a>7 配置读写分离</h2><p>配置文件</p>
<p>①schema.xml：定义逻辑库，表、分片节点等内容</p>
<p>②rule.xml：定义分片规则</p>
<p>③server.xml：定义用户以及系统相关变量，如端口等</p>
<p>1、修改配置文件server.xml 修改mycat用户信息，与MySQL区分，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~$ sudo vim /usr/local/mycat/conf/server.xml
</span></span><span class="line"><span class="cl">...p110
</span></span><span class="line"><span class="cl">&lt;user <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;root&#34;</span> <span class="nv">defaultAccount</span><span class="o">=</span><span class="s2">&#34;true&#34;</span>&gt;
</span></span><span class="line"><span class="cl">        &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;password&#34;</span>&gt;mycatpw&lt;/property&gt;
</span></span><span class="line"><span class="cl">        &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;schemas&#34;</span>&gt;testdb&lt;/property&gt;
</span></span><span class="line"><span class="cl">        &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;defaultSchema&#34;</span>&gt;testdb&lt;/property&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里主要设置了MyCat的用户名，密码，逻辑库的name等属性</p>
<p>2、修改配置文件 schema.xml</p>
<p>删除<code>&lt;schema&gt;</code>标签间的表信息，<code>&lt;dataNode&gt;</code>标签只留一个，<code>&lt;dataHost&gt;</code>标签只留一个，<code>&lt;writeHost&gt; &lt;readHost&gt;</code>只留一对</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~$ sudo vim /usr/local/mycat/conf/schema.xml
</span></span><span class="line"><span class="cl">&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span>?&gt;
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE mycat:schema SYSTEM <span class="s2">&#34;schema.dtd&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;mycat:schema xmlns:mycat<span class="o">=</span><span class="s2">&#34;http://io.mycat/&#34;</span>&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;schema <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;testdb&#34;</span> <span class="nv">checkSQLschema</span><span class="o">=</span><span class="s2">&#34;false&#34;</span> <span class="nv">sqlMaxLimit</span><span class="o">=</span><span class="s2">&#34;100&#34;</span> <span class="nv">dataNode</span><span class="o">=</span><span class="s2">&#34;dn1&#34;</span>&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;/schema&gt;
</span></span><span class="line"><span class="cl">    &lt;dataNode <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;dn1&#34;</span> <span class="nv">dataHost</span><span class="o">=</span><span class="s2">&#34;host1&#34;</span> <span class="nv">database</span><span class="o">=</span><span class="s2">&#34;test&#34;</span> /&gt;
</span></span><span class="line"><span class="cl">    &lt;dataHost <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;host1&#34;</span> <span class="nv">maxCon</span><span class="o">=</span><span class="s2">&#34;1000&#34;</span> <span class="nv">minCon</span><span class="o">=</span><span class="s2">&#34;10&#34;</span> <span class="nv">balance</span><span class="o">=</span><span class="s2">&#34;3&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="nv">writeType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="nv">dbType</span><span class="o">=</span><span class="s2">&#34;mysql&#34;</span> <span class="nv">dbDriver</span><span class="o">=</span><span class="s2">&#34;native&#34;</span> <span class="nv">switchType</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>  <span class="nv">slaveThreshold</span><span class="o">=</span><span class="s2">&#34;100&#34;</span>&gt;
</span></span><span class="line"><span class="cl">        &lt;heartbeat&gt;select user<span class="o">()</span>&lt;/heartbeat&gt;
</span></span><span class="line"><span class="cl">        &lt;!-- can have multi write hosts --&gt;
</span></span><span class="line"><span class="cl">        &lt;writeHost <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;hostM1&#34;</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;10.10.10.11:3306&#34;</span> <span class="nv">user</span><span class="o">=</span><span class="s2">&#34;root&#34;</span>
</span></span><span class="line"><span class="cl">                   <span class="nv">password</span><span class="o">=</span><span class="s2">&#34;zxcv&#34;</span>&gt;
</span></span><span class="line"><span class="cl">            &lt;!-- can have multi <span class="nb">read</span> hosts --&gt;
</span></span><span class="line"><span class="cl">            &lt;readHost <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;hostS2&#34;</span> <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;10.10.10.12:3306&#34;</span> <span class="nv">user</span><span class="o">=</span><span class="s2">&#34;root&#34;</span> <span class="nv">password</span><span class="o">=</span><span class="s2">&#34;zxcv&#34;</span> /&gt;
</span></span><span class="line"><span class="cl">        &lt;/writeHost&gt;
</span></span><span class="line"><span class="cl">    &lt;/dataHost&gt;
</span></span><span class="line"><span class="cl">&lt;/mycat:schema&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里设置数据节点，以及对应的后端真实的MySQL实例属性，写库和读库的属性</p>
<p>dataHost标签中有一个balance属性，用于设置读写分离</p>
<ul>
<li>balance=&ldquo;0&rdquo;, 不开启读写分离机制，所有读操作都发送到当前可用的 writeHost 上；</li>
<li>balance=&ldquo;1&rdquo;，全部的 readHost 与 stand by writeHost 参与 select 语句的负载均衡；</li>
<li>balance=&ldquo;2&rdquo;，所有读操作都随机的在 writeHost、readhost 上分发；</li>
<li>balance=&ldquo;3&rdquo;，所有读请求随机的分发到 readhost 执行，writerHost 不负担读压力</li>
</ul>
<p>MariaDB数据库账号设置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">MariaDB <span class="o">[(</span>none<span class="o">)]</span>&gt; grant all privileges on *.* to root@<span class="s1">&#39;%&#39;</span> identified by <span class="s1">&#39;zxcv&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.00 sec<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MariaDB <span class="o">[(</span>none<span class="o">)]</span>&gt; flush privileges<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="启动mycat" class="headerLink">
    <a href="#%e5%90%af%e5%8a%a8mycat" class="header-mark"></a>7.1 启动MyCat</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 前台启动</span>
</span></span><span class="line"><span class="cl">~$ sudo /usr/local/mycat/bin/mycat console
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 后台启动</span>
</span></span><span class="line"><span class="cl">~$ sudo /usr/local/mycat/bin/mycat start
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看日志</span>
</span></span><span class="line"><span class="cl">~$ sudo tail -f /usr/local/mycat/logs/wrapper.log
</span></span><span class="line"><span class="cl">STATUS <span class="p">|</span> wrapper  <span class="p">|</span> 2021/08/04 16:49:51 <span class="p">|</span> --&gt; Wrapper Started as Daemon
</span></span><span class="line"><span class="cl">STATUS <span class="p">|</span> wrapper  <span class="p">|</span> 2021/08/04 16:49:51 <span class="p">|</span> Launching a JVM...
</span></span><span class="line"><span class="cl">INFO   <span class="p">|</span> jvm <span class="m">1</span>    <span class="p">|</span> 2021/08/04 16:50:17 <span class="p">|</span> Wrapper <span class="o">(</span>Version 3.2.3<span class="o">)</span> http://wrapper.tanukisoftware.org
</span></span><span class="line"><span class="cl">INFO   <span class="p">|</span> jvm <span class="m">1</span>    <span class="p">|</span> 2021/08/04 16:50:17 <span class="p">|</span>   Copyright 1999-2006 Tanuki Software, Inc.  All Rights Reserve
</span></span><span class="line"><span class="cl">INFO   <span class="p">|</span> jvm <span class="m">1</span>    <span class="p">|</span> 2021/08/04 16:50:17 <span class="p">|</span>
</span></span><span class="line"><span class="cl">INFO   <span class="p">|</span> jvm <span class="m">1</span>    <span class="p">|</span> 2021/08/04 16:50:44 <span class="p">|</span> MyCAT Server startup successfully. see logs in logs/mycat.log
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="测试mycat" class="headerLink">
    <a href="#%e6%b5%8b%e8%af%95mycat" class="header-mark"></a>7.2 测试MyCat</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~$ mysql -h 10.10.10.13 -P <span class="m">8066</span> -u root -p
</span></span><span class="line"><span class="cl">Enter password:
</span></span><span class="line"><span class="cl">Welcome to the MariaDB monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span></span><span class="line"><span class="cl">Your MySQL connection id is <span class="m">4</span>
</span></span><span class="line"><span class="cl">Server version: 5.6.29-mycat-1.6.7.4-release-20200105164103 MyCat Server <span class="o">(</span>OpenCloudDB<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2018, Oracle, MariaDB Corporation Ab and others.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Type <span class="s1">&#39;help;&#39;</span> or <span class="s1">&#39;\h&#39;</span> <span class="k">for</span> help. Type <span class="s1">&#39;\c&#39;</span> to clear the current input statement.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MySQL <span class="o">[(</span>none<span class="o">)]</span>&gt;
</span></span><span class="line"><span class="cl">MySQL <span class="o">[(</span>none<span class="o">)]</span>&gt; show databases<span class="p">;</span>
</span></span><span class="line"><span class="cl">+----------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> DATABASE <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> testdb   <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----------+
</span></span><span class="line"><span class="cl"><span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>视频教程参考：<a href="https://www.bilibili.com/video/BV1mK4y1S7hS" target="_blank" rel="noopener noreffer">MyCat性能最好的开源数据库中间件_哔哩哔哩_bilibili</a></p>]]></description></item><item><title>K8S 集群搭建指南</title><link>https://blog.hellolinux.cc/2021/k8s-cluster-guide/</link><pubDate>Sun, 11 Jul 2021 10:17:18 +0000</pubDate><author><name>Neal</name><uri>https://blog.hellolinux.cc</uri><email>pengshp3@outlook.com</email></author><guid>https://blog.hellolinux.cc/2021/k8s-cluster-guide/</guid><description><![CDATA[<p><figure><a class="lightgallery" href="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/Kubernetes_New.png" title="Kubernetes_New" data-thumbnail="https://hugoblog-img-1251694304.cos.ap-guangzhou.myqcloud.com/blog/Kubernetes_New.png" data-sub-html="<h2>k8s</h2><p>Kubernetes_New</p>">
        
    </a><figcaption class="image-caption">k8s</figcaption>
    </figure></p>
<p>Kubernetes 是一个自动化的容器编排平台，它负责应用的部署、应用的弹性以及应用的管理，本文介绍使用<code>kubeadm</code>搭建 K8S 集群。</p>
<h2 id="环境准备" class="headerLink">
    <a href="#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87" class="header-mark"></a>1 环境准备</h2><h3 id="主机配置" class="headerLink">
    <a href="#%e4%b8%bb%e6%9c%ba%e9%85%8d%e7%bd%ae" class="header-mark"></a>1.1 主机配置</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>操作系统</th>
<th>配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master</td>
<td>10.10.10.60</td>
<td>CentOS7.9</td>
<td>2CPU  2G内存  20G硬盘</td>
</tr>
<tr>
<td>Node1</td>
<td>10.10.10.61</td>
<td>CentOS7.9</td>
<td>2CPU  2G内存  20G硬盘</td>
</tr>
<tr>
<td>Node2</td>
<td>10.10.10.62</td>
<td>CentOS7.9</td>
<td>2CPU  2G内存  20G硬盘</td>
</tr>
</tbody>
</table>
<p>自行安装<code>Docker</code></p>
<p>以下环境配置需在三台主机都要执行</p>
<ol>
<li>关闭selinux</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">setenforce <span class="m">0</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s2">&#34;s/SELINUX=enforcing/SELINUX=disabled/g&#34;</span> /etc/selinux/config
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>关闭swap分区或禁用swap文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ swapoff -a
</span></span><span class="line"><span class="cl">$ sed -ri <span class="s1">&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab    <span class="c1"># 永久</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>关闭防火墙</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># systemctl stop firewalld</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># systemctl disable firewalld</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>修改内核参数</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ vim /etc/sysctl.conf
</span></span><span class="line"><span class="cl">net.ipv4.ip_forward <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">net.bridge.bridge-nf-call-iptables <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">net.bridge.bridge-nf-call-ip6tables <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">$ sysctl -p
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>启用内核模块</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ vim /etc/sysconfig/modules/ipvs.modules
</span></span><span class="line"><span class="cl">modprobe -- ip_vs
</span></span><span class="line"><span class="cl">modprobe -- ip_vs_rr
</span></span><span class="line"><span class="cl">modprobe -- ip_vs_wrr
</span></span><span class="line"><span class="cl">modprobe -- ip_vs_sh
</span></span><span class="line"><span class="cl">modprobe -- nf_conntrack_ipv4
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>配置hosts</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ vim /etc/hosts
</span></span><span class="line"><span class="cl">10.10.10.60 master
</span></span><span class="line"><span class="cl">10.10.10.61 node1
</span></span><span class="line"><span class="cl">10.10.10.62 node2
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>配置时间同步</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 时间同步</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ sudo vim /etc/chrony.conf
</span></span><span class="line"><span class="cl">server ntp.aliyun.com iburst
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ sudo systemctl restart chronyd.service
</span></span></code></pre></td></tr></table>
</div>
</div><p>重启系统</p>
<h3 id="安装k8s" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85k8s" class="header-mark"></a>1.2 安装K8S</h3><ol>
<li>配置Kubernets 的yum源</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ vim /etc/yum.repos.d/kubernetes.repo
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubernetes<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">name</span><span class="o">=</span>Kubernetes
</span></span><span class="line"><span class="cl"><span class="nv">baseurl</span><span class="o">=</span>http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span><span class="line"><span class="cl"><span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">gpgcheck</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">repo_gpgcheck</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">gpgkey</span><span class="o">=</span>http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span><span class="line"><span class="cl">	http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>安装kubelet、kubeadm、kubectl[v1.21.2]</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ yum install -y kubelet kubeadm kubectl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 指定版本</span>
</span></span><span class="line"><span class="cl">$ yum install -y kubelet-1.20.0 kubeadm-1.20.0 kubectl-1.20.0
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>启动kubelet服务</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ sudo systemctl <span class="nb">enable</span> kubelet
</span></span><span class="line"><span class="cl">$ sudo systemctl start kubelet
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="设置docker" class="headerLink">
    <a href="#%e8%ae%be%e7%bd%aedocker" class="header-mark"></a>1.3 设置Docker</h3><ol>
<li>修改Docker配置文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ vim /etc/docker/daemon.json
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;registry-mirrors&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;https://xxxxxxx.mirror.aliyuncs.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">]</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;insecure-registries&#34;</span>: <span class="o">[]</span>,
</span></span><span class="line"><span class="cl">  	<span class="s2">&#34;exec-opts&#34;</span>: <span class="o">[</span><span class="s2">&#34;native.cgroupdriver=systemd&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ sudo systemctl restart docker.service
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="kubernetes集群初始化" class="headerLink">
    <a href="#kubernetes%e9%9b%86%e7%be%a4%e5%88%9d%e5%a7%8b%e5%8c%96" class="header-mark"></a>2 kubernetes集群初始化</h2><p>Master节点创建集群（该操作只在master主机执行）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ sudo kubeadm init <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--kubernetes-version<span class="o">=</span>v1.21.2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--image-repository registry.aliyuncs.com/google_containers <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--pod-network-cidr<span class="o">=</span>10.244.0.0/16 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--service-cidr<span class="o">=</span>10.96.0.0/12 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--apiserver-advertise-address<span class="o">=</span>10.10.10.60
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址。</p>
<blockquote>
<p>如果失败，使用<code>kubeadm reset</code> 重置</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span></code></pre></td></tr></table>
</div>
</div><p>node节点加入集群</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># node1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-node1<span class="o">]</span> ~$ sudo kubeadm join 10.10.10.60:6443 --token tzbczr.r1lmokzaxfnirp73 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --discovery-token-ca-cert-hash sha256:b9e7a95e7ac84f97c2486ff850b9891c61c32d35d57a8248401f62b97660ea2e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># node2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-node2<span class="o">]</span> ~$ sudo kubeadm join 10.10.10.60:6443 --token tzbczr.r1lmokzaxfnirp73 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --discovery-token-ca-cert-hash sha256:b9e7a95e7ac84f97c2486ff850b9891c61c32d35d57a8248401f62b97660ea2e
</span></span></code></pre></td></tr></table>
</div>
</div><p>master节点查看node节点信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ kubectl get nodes
</span></span><span class="line"><span class="cl">NAME         STATUS   ROLES                  AGE   VERSION
</span></span><span class="line"><span class="cl">k8s-master   Ready    control-plane,master   61m   v1.21.2
</span></span><span class="line"><span class="cl">k8s-node1    Ready    &lt;none&gt;                 47m   v1.21.2
</span></span><span class="line"><span class="cl">k8s-node2    Ready    &lt;none&gt;                 46m   v1.21.2
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="kubernetes安装cni网络插件" class="headerLink">
    <a href="#kubernetes%e5%ae%89%e8%a3%85cni%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6" class="header-mark"></a>2.1 kubernetes安装CNI网络插件</h3><p>kubernetes支持多种网络插件，如：flannel、calico、canal等，任选一种使用即可，本实验选择flannel</p>
<p>只在master节点安装flannel插件即可，该插件使用的是DaemonSet控制器，该控制器会在每个节点上都运行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">#获取flannel配置文件</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#执行文件启动flannel</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl apply -f kube-flannel.yml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>等待几分钟，查看状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ kubectl get pods --all-namespaces
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   coredns-558bd4d5db-kzvhc             1/1     Running   <span class="m">0</span>          63m
</span></span><span class="line"><span class="cl">kube-system   coredns-558bd4d5db-p7x9t             1/1     Running   <span class="m">0</span>          63m
</span></span><span class="line"><span class="cl">kube-system   etcd-k8s-master                      1/1     Running   <span class="m">0</span>          63m
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-k8s-master            1/1     Running   <span class="m">0</span>          64m
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-k8s-master   1/1     Running   <span class="m">0</span>          64m
</span></span><span class="line"><span class="cl">kube-system   kube-flannel-ds-pfll6                1/1     Running   <span class="m">0</span>          49m
</span></span><span class="line"><span class="cl">kube-system   kube-flannel-ds-xfvsn                1/1     Running   <span class="m">0</span>          50m
</span></span><span class="line"><span class="cl">kube-system   kube-flannel-ds-xvsst                1/1     Running   <span class="m">0</span>          52m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-9zjlz                     1/1     Running   <span class="m">0</span>          50m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-nj8lm                     1/1     Running   <span class="m">0</span>          49m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-sqfkx                     1/1     Running   <span class="m">0</span>          63m
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-k8s-master            1/1     Running   <span class="m">0</span>          63m
</span></span></code></pre></td></tr></table>
</div>
</div><p>全部显示<code>running</code>则说明搭建成功了。</p>
<h3 id="测试kubernets-集群" class="headerLink">
    <a href="#%e6%b5%8b%e8%af%95kubernets-%e9%9b%86%e7%be%a4" class="header-mark"></a>2.2 测试Kubernets 集群</h3><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ kubectl create deployment nginx --image<span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">deployment.apps/nginx created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ kubectl expose deployment nginx --port<span class="o">=</span><span class="m">80</span> --type<span class="o">=</span>NodePort
</span></span><span class="line"><span class="cl">service/nginx exposed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ kubectl get pods,svc
</span></span><span class="line"><span class="cl">NAME                         READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod/nginx-6799fc88d8-5982c   1/1     Running   <span class="m">0</span>          73s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="cl">service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        14h
</span></span><span class="line"><span class="cl">service/nginx        NodePort    10.104.158.32   &lt;none&gt;        80:32389/TCP   20s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 测试</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@k8s-master<span class="o">]</span> ~$ curl -I node1:32389
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Server: nginx/1.21.1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="参考链接" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="header-mark"></a>2.2.1 参考链接：</h4><ol>
<li><a href="http://blog.hungtcs.top/2019/11/27/23-K8S%e5%ae%89%e8%a3%85%e8%bf%87%e7%a8%8b%e7%ac%94%e8%ae%b0/" target="_blank" rel="noopener noreffer">K8S安装过程笔记 | 鸿则的博客 (hungtcs.top)</a></li>
<li><a href="https://www.bilibili.com/video/BV1oJ411d7Tv" target="_blank" rel="noopener noreffer">Kubernetes/K8S 集群环境搭建_哔哩哔哩_bilibili</a></li>
<li><a href="https://kubernetes.io/zh/" target="_blank" rel="noopener noreffer">Kubernetes</a></li>
</ol>]]></description></item><item><title>MooseFS网络分布式文件系统指南</title><link>https://blog.hellolinux.cc/2021/moosefs-guide/</link><pubDate>Wed, 20 Jan 2021 19:09:02 +0000</pubDate><author><name>Neal</name><uri>https://blog.hellolinux.cc</uri><email>pengshp3@outlook.com</email></author><guid>https://blog.hellolinux.cc/2021/moosefs-guide/</guid><description><![CDATA[<p><figure><a class="lightgallery" href="https://pengshp.coding.net/p/images/d/images/git/raw/master/moosefs-pro-architecture.png" title="moosefs-pro-architecture" data-thumbnail="https://pengshp.coding.net/p/images/d/images/git/raw/master/moosefs-pro-architecture.png" data-sub-html="<h2>MooseFS</h2><p>moosefs-pro-architecture</p>">
        
    </a><figcaption class="image-caption">MooseFS</figcaption>
    </figure></p>
<p>MooseFS是一个具备冗余容错功能、高可用、高性能、可扩展的网络分布式文件系统，它将数据分别存放在多个物理服务器或一个服务器的多块磁盘，确保一份数据有多个备份副本，然而对于访问MFS的客户端或者用户来说，整个网络分布式文件系统集群看起来就像一个虚拟磁盘一样。MooseFS分为普通版和Pro版本，Pro版本需要授权。</p>
<h1 id="moosefs-特性" class="headerLink">
    <a href="#moosefs-%e7%89%b9%e6%80%a7" class="header-mark"></a>MooseFS 特性</h1><p>a.高可靠性：每一份数据可以设置多个备份（多分数据），并可以存储在不同的主机上</p>
<p>b.高可扩展性：可以很轻松的通过增加主机的磁盘容量或增加主机数量来动态扩展整个文件系统的存储量</p>
<p>c.高可容错性：我们可以通过对mfs进行系统设置，实现当数据文件被删除后的一段时间内，依旧存放于主机的回收站中，以备误删除恢复数据</p>
<p>d.高数据一致性：即使文件被写入、访问时，我们依然可以轻松完成对文件的一致性快照；</p>
<h1 id="moosefs-应用场景" class="headerLink">
    <a href="#moosefs-%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af" class="header-mark"></a>MooseFS 应用场景</h1><ul>
<li>
<p>大规模高并发的线上数据存储及访问（小文件，大文件都适合）</p>
</li>
<li>
<p>大规模的数据处理，如日志分析，小文件强调性能不用HDFS</p>
</li>
</ul>
<h1 id="moosefs-组成" class="headerLink">
    <a href="#moosefs-%e7%bb%84%e6%88%90" class="header-mark"></a>MooseFS 组成</h1><ul>
<li>
<p>管理服务器 (master server) 简称 <code>master</code> ：</p>
<p>这个组件的角色是管理整个mfs文件系统的主服务器，除了分发用户请求外，还用来存储整个文件系统中每个数据文件的metadata信息，metadate（元数据）信息包括文件（也可以是目录，socket，管道，块设备等）的大小，属性，文件的位置路径等。</p>
</li>
<li>
<p>云数据备份服务器 (Metadata backup servers) 简称 <code>metalogger</code>：</p>
<p>这个组件的作用是备份管理服务器master的变化的metadata信息日志文件，文件类型为changelog_ml.*.mfs。以便于在管理服务器出问题时，可以经过简单的操作即可让新的主服务器进行工作。</p>
</li>
<li>
<p>数据存储服务器组（chunk servers）简称data：</p>
<p>这个组件就是真正存放数据文件实体的服务器了，这个角色可以有多台不同的物理服务器或不同的磁盘及分区来充当，当配置数据的副本多于一份时，据写入到一个数据服务器后，会根据算法在其他数据服务器上进行同步备份。</p>
</li>
<li>
<p>客户机服务器组（client servers）简称 <code>client</code>：</p>
<p>这个组件就是挂载并使用mfs文件系统的客户端，当读写文件时，客户端首先会连接主管理服务器获取数据的metadata信息，然后根据得到的metadata信息，访问数据服务器读取或写入文件实体，mfs客户端通过fuse mechanism实现挂载mfs文件系统的，因此，只有系统支持fuse，就可以作为客户端访问mfs整个文件系统。</p>
</li>
</ul>
<h1 id="moosefs-原理" class="headerLink">
    <a href="#moosefs-%e5%8e%9f%e7%90%86" class="header-mark"></a>MooseFS 原理</h1><ol>
<li>
<p>Master记录着管理信息，比如：文件路径|大小|存储的位置(ip,port,chunkid)|份数|时间等，元数据信息存在于内存中，会定期写入metadata.mfs.back文件中，定期同步到metalogger，操作实时写入changelog.*.mfs，实时同步到metalogger中。master启动将metadata.mfs载入内存，重命名为metadata.mfs.back文件。</p>
</li>
<li>
<p>文件以chunk大小存储，每chunk最大为64M，小于64M的，该chunk的大小即为该文件大小（验证实际chunk文件略大于实际文件），超过64M的文件将被切分，以每一份（chunk）的大小不超过64M为原则；块的生成遵循规则：目录循环写入(00-FF 256个目录循环，step为2)、chunk文件递增生成、大文件切分目录连续。</p>
</li>
<li>
<p>Chunkserver上的剩余存储空间要大于1GB（Reference Guide有提到），新的数据才会被允许写入，否则，你会看到No space left on device的提示</p>
</li>
<li>
<p>文件可以有多份copy，当goal为1时，文件会被随机存到一台chunkserver上，当goal的数大于1时，copy会由master调度保存到不同的chunkserver上，goal的大小不要超过chunkserver的数量，否则多出的copy，不会有chunkserver去存。</p>
</li>
</ol>
<h1 id="moosefs-集群搭建" class="headerLink">
    <a href="#moosefs-%e9%9b%86%e7%be%a4%e6%90%ad%e5%bb%ba" class="header-mark"></a>MooseFS 集群搭建</h1><h2 id="实验架构图" class="headerLink">
    <a href="#%e5%ae%9e%e9%aa%8c%e6%9e%b6%e6%9e%84%e5%9b%be" class="header-mark"></a>1 实验架构图</h2><p></p>
<h2 id="环境准备" class="headerLink">
    <a href="#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87" class="header-mark"></a>2 环境准备</h2><ul>
<li>操作系统：CentOS7</li>
<li>MooseFS版本：3.0.115</li>
<li>chunk servers 加入 5G 的磁盘</li>
</ul>
<blockquote>
<p>以下步骤在所有节点操作</p>
</blockquote>
<h3 id="1-配置moosefs软件源" class="headerLink">
    <a href="#1-%e9%85%8d%e7%bd%aemoosefs%e8%bd%af%e4%bb%b6%e6%ba%90" class="header-mark"></a>2.1 1. 配置MooseFS软件源</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 导入验证密钥</span>
</span></span><span class="line"><span class="cl">curl <span class="s2">&#34;https://ppa.moosefs.com/RPM-GPG-KEY-MooseFS&#34;</span> &gt; /etc/pki/rpm-gpg/RPM-GPG-KEY-MooseFS
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加yum 源</span>
</span></span><span class="line"><span class="cl"><span class="c1"># For CentOS8</span>
</span></span><span class="line"><span class="cl">$ curl <span class="s2">&#34;http://ppa.moosefs.com/MooseFS-3-el8.repo&#34;</span> &gt; /etc/yum.repos.d/MooseFS.repo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For CentOS7</span>
</span></span><span class="line"><span class="cl">$ curl <span class="s2">&#34;http://ppa.moosefs.com/MooseFS-3-el7.repo&#34;</span> &gt; /etc/yum.repos.d/MooseFS.repo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For CentOS6</span>
</span></span><span class="line"><span class="cl">$ curl <span class="s2">&#34;http://ppa.moosefs.com/MooseFS-3-el6.repo&#34;</span> &gt; /etc/yum.repos.d/MooseFS.repo
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-配置解析" class="headerLink">
    <a href="#2-%e9%85%8d%e7%bd%ae%e8%a7%a3%e6%9e%90" class="header-mark"></a>2.2 2. 配置解析</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 所有节点</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ <span class="nb">echo</span> <span class="s1">&#39;10.10.10.11 mfsmaster&#39;</span> &gt;&gt; /etc/hosts
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="搭建步骤" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba%e6%ad%a5%e9%aa%a4" class="header-mark"></a>3 搭建步骤</h2><h3 id="master-server" class="headerLink">
    <a href="#master-server" class="header-mark"></a>3.1 Master Server</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ yum install moosefs-master moosefs-cgi moosefs-cgiserv moosefs-cli
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ vim /etc/mfs/mfsexports.cfg
</span></span><span class="line"><span class="cl">10.10.10.0/24   /   rw,alldirs,maproot<span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ·  表示MFS文件系统</span>
</span></span><span class="line"><span class="cl"><span class="c1"># rw,alldirs,maproot=0    表示客户端拥有的权限</span>
</span></span><span class="line"><span class="cl"><span class="c1"># rw  读写方式分享</span>
</span></span><span class="line"><span class="cl"><span class="c1"># alldirs  允许挂载任何指定的子目录</span>
</span></span><span class="line"><span class="cl"><span class="c1"># maproot   映射为root用户还是指定的用户，为0则不映射</span>
</span></span><span class="line"><span class="cl"><span class="c1"># password  指定客户端密码</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改master server 配置文件</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ vim /etc/mfs/mfsmaster.cfg
</span></span><span class="line"><span class="cl"><span class="nv">WORKING_USER</span> <span class="o">=</span> mfs
</span></span><span class="line"><span class="cl"><span class="nv">WORKING_GROUP</span> <span class="o">=</span> mfs
</span></span><span class="line"><span class="cl"><span class="nv">SYSLOG_IDENT</span> <span class="o">=</span> mfsmaster
</span></span><span class="line"><span class="cl"><span class="nv">DATA_PATH</span> <span class="o">=</span> /var/lib/mfs
</span></span><span class="line"><span class="cl"><span class="nv">EXPORTS_FILENAME</span> <span class="o">=</span> /etc/mfs/mfsexports.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动服务</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ systemctl <span class="nb">enable</span> --now moosefs-master.service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 配置MooseFS CGI Server</span>
</span></span><span class="line"><span class="cl"><span class="c1"># MooseFS CGI 监控接口用于观察和分析 MooseFS 当前的状态</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ systemctl <span class="nb">enable</span> --now moosefs-cgiserv.service
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ netstat -antpl <span class="p">|</span>grep <span class="m">9425</span>
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:9425            0.0.0.0:*               LISTEN      2703/python2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 浏览器访问 </span>
</span></span><span class="line"><span class="cl">firefox http://10.10.10.11:9425
</span></span></code></pre></td></tr></table>
</div>
</div><p></p>
<h3 id="metadata-backup-servers-metaloggers" class="headerLink">
    <a href="#metadata-backup-servers-metaloggers" class="header-mark"></a>3.2 Metadata backup servers (Metaloggers)</h3><p>元数据备份节点配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ yum install moosefs-metalogger
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ vim /etc/mfs/mfsmetalogger.cfg
</span></span><span class="line"><span class="cl"><span class="nv">WORKING_USER</span> <span class="o">=</span> mfs
</span></span><span class="line"><span class="cl"><span class="nv">WORKING_GROUP</span> <span class="o">=</span> mfs
</span></span><span class="line"><span class="cl"><span class="nv">SYSLOG_IDENT</span> <span class="o">=</span> mfsmetalogger
</span></span><span class="line"><span class="cl"><span class="nv">DATA_PATH</span> <span class="o">=</span> /var/lib/mfs
</span></span><span class="line"><span class="cl"><span class="nv">BIND_HOST</span> <span class="o">=</span> 10.10.10.12
</span></span><span class="line"><span class="cl"><span class="nv">MASTER_HOST</span> <span class="o">=</span> mfsmaster
</span></span><span class="line"><span class="cl"><span class="nv">MASTER_PORT</span> <span class="o">=</span> <span class="m">9419</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动服务</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ systemctl <span class="nb">enable</span> --now moosefs-metalogger.service
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ netstat -antpl <span class="p">|</span>grep mfs
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 10.10.10.12:42183       10.10.10.11:9419        ESTABLISHED 2384/mfsmetalogger
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="chunkservers配置" class="headerLink">
    <a href="#chunkservers%e9%85%8d%e7%bd%ae" class="header-mark"></a>3.3 Chunkservers配置</h3><p>① 磁盘设置</p>
<p>每台 chunkserver 上添加一块5G的磁盘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 分区</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ parted --align optimal /dev/sdb
</span></span><span class="line"><span class="cl">GNU Parted 3.1
</span></span><span class="line"><span class="cl">使用 /dev/sdb
</span></span><span class="line"><span class="cl">Welcome to GNU Parted! Type <span class="s1">&#39;help&#39;</span> to view a list of commands.
</span></span><span class="line"><span class="cl"><span class="o">(</span>parted<span class="o">)</span> mklabel gpt
</span></span><span class="line"><span class="cl"><span class="o">(</span>parted<span class="o">)</span> mkpart mfschunks1 0% 100%
</span></span><span class="line"><span class="cl"><span class="o">(</span>parted<span class="o">)</span> q
</span></span><span class="line"><span class="cl">信息: You may need to update /etc/fstab.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 格式化</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ mkfs -t xfs /dev/sdb1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 挂载</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ mkdir /mnt/mfschunks1
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ mount /mnt/mfschunks1
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ chown mfs.mfs /mnt/mfschunks1
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ chmod <span class="m">770</span> /mnt/mfschunks1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置开机自动挂载</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ vim /etc/fstab
</span></span><span class="line"><span class="cl">/dev/sdb1                                 /mnt/mfschunks1         xfs     defaults        <span class="m">0</span> <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>② chunk 服务设置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 安装软件包</span>
</span></span><span class="line"><span class="cl">$ yum install moosefs-chunkserver
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改配置文件</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ vim /etc/mfs/mfschunkserver.cfg
</span></span><span class="line"><span class="cl"><span class="nv">WORKING_USER</span> <span class="o">=</span> mfs
</span></span><span class="line"><span class="cl"><span class="nv">WORKING_GROUP</span> <span class="o">=</span> mfs
</span></span><span class="line"><span class="cl"><span class="nv">SYSLOG_IDENT</span> <span class="o">=</span> mfschunkserver
</span></span><span class="line"><span class="cl"><span class="nv">DATA_PATH</span> <span class="o">=</span> /var/lib/mfs
</span></span><span class="line"><span class="cl"><span class="nv">HDD_CONF_FILENAME</span> <span class="o">=</span> /etc/mfs/mfshdd.cfg
</span></span><span class="line"><span class="cl"><span class="nv">LABELS</span> <span class="o">=</span> chunkserver1
</span></span><span class="line"><span class="cl"><span class="nv">BIND_HOST</span> <span class="o">=</span> 10.10.10.13
</span></span><span class="line"><span class="cl"><span class="nv">MASTER_HOST</span> <span class="o">=</span> mfsmaster
</span></span><span class="line"><span class="cl"><span class="nv">MASTER_PORT</span> <span class="o">=</span> <span class="m">9420</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改挂载的磁盘配置</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ vim /etc/mfs/mfshdd.cfg
</span></span><span class="line"><span class="cl">/mnt/mfschunks1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动服务，不能手动挂载 mount -a</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ systemctl <span class="nb">enable</span> --now moosefs-chunkserver.service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ netstat -antpl <span class="p">|</span>grep mfs
</span></span><span class="line"><span class="cl">tcp     <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:9422         0.0.0.0:*   LISTEN      2070/mfschunkserver
</span></span><span class="line"><span class="cl">tcp     <span class="m">0</span>      <span class="m">0</span> 10.10.10.13:38923    10.10.10.11:9420    ESTABLISHED 2070/mfschunkserver
</span></span></code></pre></td></tr></table>
</div>
</div><p></p>
<h3 id="client客户端设置" class="headerLink">
    <a href="#client%e5%ae%a2%e6%88%b7%e7%ab%af%e8%ae%be%e7%bd%ae" class="header-mark"></a>3.4 Client客户端设置</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ yum install fuse libfuse2
</span></span><span class="line"><span class="cl">$ yum install moosefs-client
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 挂载MFS文件系统</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># mkdir -p /mnt/mfs</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># mfsmount /mnt/mfs/ -H mfsmaster</span>
</span></span><span class="line"><span class="cl">mfsmaster accepted connection with parameters: read-write,restricted_ip,admin <span class="p">;</span> root mapped to root:root
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看挂载的情况</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># df -h |grep mfs</span>
</span></span><span class="line"><span class="cl">mfsmaster:9421   10G  577M  9.5G    6% /mnt/mfs
</span></span></code></pre></td></tr></table>
</div>
</div><p></p>
<h3 id="测试" class="headerLink">
    <a href="#%e6%b5%8b%e8%af%95" class="header-mark"></a>3.5 测试</h3><p>在客户端新建目录folder1 ，设置目录有一份拷贝（goal=1）,新建目录folder2 ，设置目录有一份拷贝（goal=2）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># mkdir -p /mnt/mfs/folder1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># mkdir -p /mnt/mfs/folder2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># mfssetgoal -r 1 /mnt/mfs/folder1</span>
</span></span><span class="line"><span class="cl">/mnt/mfs/folder1:
</span></span><span class="line"><span class="cl"> inodes with goal changed:                       <span class="m">1</span>
</span></span><span class="line"><span class="cl"> inodes with goal not changed:                   <span class="m">0</span>
</span></span><span class="line"><span class="cl"> inodes with permission denied:                  <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># mfssetgoal -r 2 /mnt/mfs/folder2</span>
</span></span><span class="line"><span class="cl">/mnt/mfs/folder2:
</span></span><span class="line"><span class="cl"> inodes with goal changed:                       <span class="m">0</span>
</span></span><span class="line"><span class="cl"> inodes with goal not changed:                   <span class="m">1</span>
</span></span><span class="line"><span class="cl"> inodes with permission denied:                  <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意：副本的数量不能超过chunk server的数量。</p>
<p>新建文件测试，查看文件的副本信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># echo &#39;Hello MFS!&#39; &gt; test.txt</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># cp test.txt /mnt/mfs/folder1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># cp test.txt /mnt/mfs/folder2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># mfscheckfile /mnt/mfs/folder1/test.txt</span>
</span></span><span class="line"><span class="cl">/mnt/mfs/folder1/test.txt:
</span></span><span class="line"><span class="cl"> chunks with <span class="m">1</span> copy:              <span class="m">1</span>  <span class="c1"># &lt;---- one copy</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span><span class="c1"># mfscheckfile /mnt/mfs/folder2/test.txt</span>
</span></span><span class="line"><span class="cl">/mnt/mfs/folder2/test.txt:
</span></span><span class="line"><span class="cl"> chunks with <span class="m">2</span> copies:            <span class="m">1</span>  <span class="c1"># &lt;---- two copies</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p></p>
<h3 id="安全的停止moosefs集群" class="headerLink">
    <a href="#%e5%ae%89%e5%85%a8%e7%9a%84%e5%81%9c%e6%ad%a2moosefs%e9%9b%86%e7%be%a4" class="header-mark"></a>3.6 安全的停止MooseFS集群</h3><ol>
<li>客户端卸载所有的挂载点</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span> $ lsof -n <span class="p">|</span>grep mfsmount
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@dev ~<span class="o">]</span> $ umount /mnt/mfs
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>停止 Chunkserver 服务</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ systemctl stop moosefs-chunkserver.service
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>停止 Master Server 服务</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ systemctl stop moosefs-master.service
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>停止 Metalogger 服务</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@CentOS<span class="o">]</span> ~$ systemctl stop moosefs-metalogger.service
</span></span></code></pre></td></tr></table>
</div>
</div><p>参考：</p>
<p><a href="https://moosefs.com/" target="_blank" rel="noopener noreffer">MooseFS官网</a></p>]]></description></item><item><title>Linux配置Tinyproxy代理</title><link>https://blog.hellolinux.cc/2020/linux-tinyproxy-config/</link><pubDate>Thu, 20 Aug 2020 14:18:32 +0000</pubDate><author><name>Neal</name><uri>https://blog.hellolinux.cc</uri><email>pengshp3@outlook.com</email></author><guid>https://blog.hellolinux.cc/2020/linux-tinyproxy-config/</guid><description><![CDATA[<p><figure><a class="lightgallery" href="https://pengshp.coding.net/p/images/d/images/git/raw/master/tinyproxy.png" title="tinyproxy" data-thumbnail="https://pengshp.coding.net/p/images/d/images/git/raw/master/tinyproxy.png" data-sub-html="<h2>Tinyproxy</h2><p>tinyproxy</p>">
        
    </a><figcaption class="image-caption">Tinyproxy</figcaption>
    </figure></p>
<p><code>Tinyproxy</code>是一个轻量级的http代理软件，速度快体积小，可以使用来把socks5代理转为http代理。测试环境为 🔥 ​ArchLinux,IP:172.16.10.18,Socks5端口1090.</p>
<h3 id="1查询软件包" class="headerLink">
    <a href="#1%e6%9f%a5%e8%af%a2%e8%bd%af%e4%bb%b6%e5%8c%85" class="header-mark"></a>0.1 1.查询软件包</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">~$ pacman -Ss tinyproxy
</span></span><span class="line"><span class="cl">community/tinyproxy 1.10.0-2 <span class="o">[</span>已安装<span class="o">]</span>
</span></span><span class="line"><span class="cl">    A light-weight HTTP proxy daemon <span class="k">for</span> POSIX operating systems.
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2安装tinyproxy" class="headerLink">
    <a href="#2%e5%ae%89%e8%a3%85tinyproxy" class="header-mark"></a>0.2 2.安装tinyproxy</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">~$ sudo pacman -Sy tinyproxy
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3修改配置文件" class="headerLink">
    <a href="#3%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="header-mark"></a>0.3 3.修改配置文件</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">~$ vim /etc/tinyproxy/tinyproxy.conf
</span></span><span class="line"><span class="cl">User tinyproxy
</span></span><span class="line"><span class="cl">Group tinyproxy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Port <span class="m">8888</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Listen 0.0.0.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Timeout <span class="m">600</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ErrorFile <span class="m">404</span> <span class="s2">&#34;/usr/share/tinyproxy/404.html&#34;</span>
</span></span><span class="line"><span class="cl">ErrorFile <span class="m">400</span> <span class="s2">&#34;/usr/share/tinyproxy/400.html&#34;</span>
</span></span><span class="line"><span class="cl">ErrorFile <span class="m">503</span> <span class="s2">&#34;/usr/share/tinyproxy/503.html&#34;</span>
</span></span><span class="line"><span class="cl">ErrorFile <span class="m">403</span> <span class="s2">&#34;/usr/share/tinyproxy/403.html&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DefaultErrorFile <span class="s2">&#34;/usr/share/tinyproxy/default.html&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">StatFile <span class="s2">&#34;/usr/share/tinyproxy/stats.html&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">LogFile <span class="s2">&#34;/var/log/tinyproxy/tinyproxy.log&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#关闭syslog，使用自定义的日志文件</span>
</span></span><span class="line"><span class="cl"><span class="c1">#Syslog On</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">LogLevel Info
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PidFile <span class="s2">&#34;/var/run/tinyproxy/tinyproxy.pid&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在请求头中加入客户端IP</span>
</span></span><span class="line"><span class="cl"><span class="c1">#XTinyproxy Yes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#设置上游代理，转换上游socks5代理为http代理</span>
</span></span><span class="line"><span class="cl">upstream socks5 127.0.0.1:1090
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MaxClients <span class="m">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MinSpareServers <span class="m">5</span>
</span></span><span class="line"><span class="cl">MaxSpareServers <span class="m">20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">StartServers <span class="m">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MaxRequestsPerChild <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 允许局域网的哪些主机访问</span>
</span></span><span class="line"><span class="cl">Allow 172.16.10.0/24
</span></span><span class="line"><span class="cl">Allow 192.168.1.0/24
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AddHeader <span class="s2">&#34;X-My-Header&#34;</span> <span class="s2">&#34;Powered by Tinyproxy&#34;</span>
</span></span><span class="line"><span class="cl">ViaProxyName <span class="s2">&#34;tinyproxy&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4启动服务" class="headerLink">
    <a href="#4%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1" class="header-mark"></a>0.4 4.启动服务</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">~$ sudo systemctl start tinyproxy.service
</span></span><span class="line"><span class="cl">~$ sudo systemctl <span class="nb">enable</span> tinyproxy.service
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="5测试" class="headerLink">
    <a href="#5%e6%b5%8b%e8%af%95" class="header-mark"></a>0.5 5.测试</h3><p>在局域网内的其它主机上把代理设置为上面的Tinyproxy,测试请求头信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">xdl@aml:~$ <span class="nb">export</span> <span class="nv">http_proxy</span><span class="o">=</span><span class="s1">&#39;http://172.16.10.18:8888&#39;</span>
</span></span><span class="line"><span class="cl">xdl@aml:~$ <span class="nb">export</span> <span class="nv">https_proxy</span><span class="o">=</span><span class="s1">&#39;http://172.16.10.18:8888&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">xdl@aml:~$ curl -I www.baidu.com
</span></span><span class="line"><span class="cl">HTTP/1.0 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Via: 1.1 tinyproxy <span class="o">(</span>tinyproxy/1.10.0<span class="o">)</span>   <span class="c1"># &lt;------ 请求头中包含了Tinyproxy</span>
</span></span><span class="line"><span class="cl">Cache-Control: private, no-cache, no-store, proxy-revalidate, no-transform
</span></span><span class="line"><span class="cl">Content-Type: text/html
</span></span><span class="line"><span class="cl">Etag: <span class="s2">&#34;575e1f6f-115&#34;</span>
</span></span><span class="line"><span class="cl">Last-Modified: Mon, <span class="m">13</span> Jun <span class="m">2016</span> 02:50:23 GMT
</span></span><span class="line"><span class="cl">Pragma: no-cache
</span></span><span class="line"><span class="cl">Server: bfe/1.0.8.18
</span></span><span class="line"><span class="cl">Accept-Ranges: bytes
</span></span><span class="line"><span class="cl">Date: Thu, <span class="m">20</span> Aug <span class="m">2020</span> 06:57:01 GMT
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">277</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="参考" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>0.6 参考：</h3><p>1.<a href="https://tinyproxy.github.io/" target="_blank" rel="noopener noreffer">https://tinyproxy.github.io/</a></p>
<p>2.<a href="https://github.com/tinyproxy/tinyproxy" target="_blank" rel="noopener noreffer">https://github.com/tinyproxy/tinyproxy</a></p>
<p>3.<a href="https://linux.cn/article-7119-1.html" target="_blank" rel="noopener noreffer">https://linux.cn/article-7119-1.html</a></p>]]></description></item><item><title>Ceph 分布式系统搭建</title><link>https://blog.hellolinux.cc/2020/cephfs-setup/</link><pubDate>Tue, 18 Aug 2020 17:49:08 +0000</pubDate><author><name>Neal</name><uri>https://blog.hellolinux.cc</uri><email>pengshp3@outlook.com</email></author><guid>https://blog.hellolinux.cc/2020/cephfs-setup/</guid><description><![CDATA[<p><figure><a class="lightgallery" href="https://pengshp.coding.net/p/images/d/images/git/raw/master/ceph-blog.jpg" title="ceph-blog" data-thumbnail="https://pengshp.coding.net/p/images/d/images/git/raw/master/ceph-blog.jpg" data-sub-html="<h2>Ceph</h2><p>ceph-blog</p>">
        
    </a><figcaption class="image-caption">Ceph</figcaption>
    </figure></p>
<p>上一篇介绍了Ceph分布式文件系统，下面介绍Ceph分布式文件系统的安装配置和使用</p>
<h1 id="一环境准备" class="headerLink">
    <a href="#%e4%b8%80%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87" class="header-mark"></a>一、环境准备</h1><h2 id="1-环境说明" class="headerLink">
    <a href="#1-%e7%8e%af%e5%a2%83%e8%af%b4%e6%98%8e" class="header-mark"></a>1 1. 环境说明</h2><ul>
<li>操作系统：CentOS Linux 7</li>
<li>node[1-3]添加一块5G的磁盘</li>
<li>Ceph 版本：nautilus</li>
</ul>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>admin</td>
<td>10.10.10.60</td>
<td>管理节点 安装ceph-deploy</td>
</tr>
<tr>
<td>node1</td>
<td>10.10.10.61</td>
<td>mon mgr osd</td>
</tr>
<tr>
<td>node2</td>
<td>10.10.10.62</td>
<td>osd</td>
</tr>
<tr>
<td>node3</td>
<td>10.10.10.63</td>
<td>osd</td>
</tr>
<tr>
<td>client</td>
<td>10.10.10.64</td>
<td>client测试</td>
</tr>
</tbody>
</table>
<h2 id="2配置相应的环境" class="headerLink">
    <a href="#2%e9%85%8d%e7%bd%ae%e7%9b%b8%e5%ba%94%e7%9a%84%e7%8e%af%e5%a2%83" class="header-mark"></a>2 2.配置相应的环境</h2><blockquote>
<p>以下操作在所有节点配置</p>
</blockquote>
<p>2.1 新建用户</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">## all</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@admin<span class="o">]</span> ~$ sudo useradd -G wheel ceph                        
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@admin<span class="o">]</span> ~$ <span class="nb">echo</span> <span class="s1">&#39;ceph&#39;</span> <span class="p">|</span>sudo passwd --stdin ceph
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.2 修改hosts</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@admin ~<span class="o">]</span>$ sudo vim /etc/hosts
</span></span><span class="line"><span class="cl"><span class="c1"># Ceph</span>
</span></span><span class="line"><span class="cl">10.10.10.60 admin
</span></span><span class="line"><span class="cl">10.10.10.61 node1
</span></span><span class="line"><span class="cl">10.10.10.62 node2
</span></span><span class="line"><span class="cl">10.10.10.63 node3
</span></span><span class="line"><span class="cl">10.10.10.64 client
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.3 配置时间同步</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@admin<span class="o">]</span> ~$ vim /etc/chrony.conf
</span></span><span class="line"><span class="cl">server ntp.aliyun.com iburst
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@admin<span class="o">]</span> ~$ systemctl restart chronyd.service
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@admin<span class="o">]</span> ~$ chronyc sources -v
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.4 配置admin节点与各node节点的ssh免密登录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">## admin</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>xdl@admin<span class="o">]</span> ~$ su - ceph
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin ~<span class="o">]</span>$ ssh-keygen -t rsa -b <span class="m">1024</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin ~<span class="o">]</span>$ ssh-copy-id ceph@node1
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin ~<span class="o">]</span>$ ssh-copy-id ceph@node2
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin ~<span class="o">]</span>$ ssh-copy-id ceph@node3
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.5 配置ceph 软件源</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@node1<span class="o">]</span> ~$ vim /etc/yum.repos.d/ceph.repo
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">name</span><span class="o">=</span>Ceph packages <span class="k">for</span> <span class="nv">$basearch</span>
</span></span><span class="line"><span class="cl"><span class="nv">baseurl</span><span class="o">=</span>https://mirrors.cloud.tencent.com/ceph/rpm-nautilus/el7/<span class="nv">$basearch</span>
</span></span><span class="line"><span class="cl"><span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">priority</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="nv">gpgcheck</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">gpgkey</span><span class="o">=</span>https://mirrors.cloud.tencent.com/ceph/keys/release.asc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph-noarch<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">name</span><span class="o">=</span>Ceph noarch packages
</span></span><span class="line"><span class="cl"><span class="nv">baseurl</span><span class="o">=</span>https://mirrors.cloud.tencent.com/ceph/rpm-nautilus/el7/noarch
</span></span><span class="line"><span class="cl"><span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">priority</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="nv">gpgcheck</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">gpgkey</span><span class="o">=</span>https://mirrors.cloud.tencent.com/ceph/keys/release.asc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph-source<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">name</span><span class="o">=</span>Ceph <span class="nb">source</span> packages
</span></span><span class="line"><span class="cl"><span class="nv">baseurl</span><span class="o">=</span>https://mirrors.cloud.tencent.com/ceph/rpm-nautilus/el7/SRPMS
</span></span><span class="line"><span class="cl"><span class="nv">enabled</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">priority</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="nv">gpgcheck</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">gpgkey</span><span class="o">=</span>https://mirrors.cloud.tencent.com/ceph/keys/release.as
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1<span class="o">]</span> ~$ yum makecache
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="二安装配置" class="headerLink">
    <a href="#%e4%ba%8c%e5%ae%89%e8%a3%85%e9%85%8d%e7%bd%ae" class="header-mark"></a>二、安装配置</h1><h2 id="admin管理节点配置" class="headerLink">
    <a href="#admin%e7%ae%a1%e7%90%86%e8%8a%82%e7%82%b9%e9%85%8d%e7%bd%ae" class="header-mark"></a>1 admin管理节点配置</h2><ol>
<li>安装ceph-deploy</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@admin<span class="o">]</span> ~$ yum search ceph
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@admin<span class="o">]</span> ~$ yum install -y ceph-deploy python-setuptools
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>创建节点node1</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@admin<span class="o">]</span> ~$ su - ceph
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin ~<span class="o">]</span>$ mkdir cluster
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin ~<span class="o">]</span>$ <span class="nb">cd</span> cluster/
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ceph-deploy new node1
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ls
</span></span><span class="line"><span class="cl">ceph.conf  ceph-deploy-ceph.log  ceph.mon.keyring
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="node1节点配置" class="headerLink">
    <a href="#node1%e8%8a%82%e7%82%b9%e9%85%8d%e7%bd%ae" class="header-mark"></a>2 node1节点配置</h2><ol>
<li>安装软件包</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@node1<span class="o">]</span> ~$ yum makecache
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1<span class="o">]</span> ~$ yum install -y ceph ceph-radosgw
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1<span class="o">]</span> ~$ ceph --version
</span></span><span class="line"><span class="cl">ceph version 14.2.16 <span class="o">(</span>762032d6f509d5e7ee7dc008d80fe9c87086603c<span class="o">)</span> nautilus <span class="o">(</span>stable<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>配置mon 和 mgr</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 初始化mon; admin节点以ceph用户执行</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ceph-deploy mon create-initial
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 赋予各个节点使用命令免密码权限</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ceph-deploy admin node1 node2 node3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装ceph-mgr,只有luminous源才有，为dashboard做准备</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ceph-deploy mgr create node1
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>添加osd</li>
</ol>
<p>各个节点提供的存储空间不能太小，最好5G以上, /dev/sdb 是为osd 准备的空闲磁盘（无需格式化）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ceph-deploy osd create --data /dev/sdb node1
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ceph-deploy osd create --data /dev/sdb node2
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ceph-deploy osd create --data /dev/sdb node3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ssh node1 lsblk -f
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>查看ceph 的状态</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ssh node1 sudo ceph -s
</span></span></code></pre></td></tr></table>
</div>
</div><p></p>
<h2 id="dashboard配置" class="headerLink">
    <a href="#dashboard%e9%85%8d%e7%bd%ae" class="header-mark"></a>3 Dashboard配置</h2><ol>
<li>创建node1管理密钥</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@node1 ~<span class="o">]</span>$ sudo ceph auth get-or-create mgr.node1 mon <span class="s1">&#39;allow profile mgr&#39;</span> osd <span class="s1">&#39;allow *&#39;</span> mds <span class="s1">&#39;allow *&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>mgr.node1<span class="o">]</span>
</span></span><span class="line"><span class="cl">	<span class="nv">key</span> <span class="o">=</span> <span class="nv">AQB2RAVgLC29BhAABkyYcjDyrjShJ1C9N2hlaQ</span><span class="o">==</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>开启ceph-mgr 管理域</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@node1 ~<span class="o">]</span>$ sudo ceph-mgr -i node1
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>查看ceph 的状态，确认mgr 的状态为 active</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@node1 ~<span class="o">]</span>$ sudo ceph status
</span></span></code></pre></td></tr></table>
</div>
</div><p></p>
<ol start="4">
<li>打开 dashboard 模块</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@node1 ~<span class="o">]</span>$ sudo ceph mgr module <span class="nb">enable</span> dashboard
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>绑定开启dashboard 模块的 ceph-mgr 节点的IP地址</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@node1 ~<span class="o">]</span>$ sudo ceph config-key <span class="nb">set</span> mgr/dashboard/node1/server_addr 10.10.10.61
</span></span><span class="line"><span class="cl"><span class="nb">set</span> mgr/dashboard/node1/server_addr
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>查看监听端口</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@node1 ~<span class="o">]</span>$ sudo netstat -antp <span class="p">|</span>grep <span class="m">7000</span>
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 10.10.10.61:7000        0.0.0.0:*      LISTEN      12994/ceph-mgr
</span></span></code></pre></td></tr></table>
</div>
</div><p>浏览器访问： http://10.10.10.61:7000</p>
<h2 id="客户端的使用" class="headerLink">
    <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e7%9a%84%e4%bd%bf%e7%94%a8" class="header-mark"></a>4 客户端的使用</h2><p>客户端需要更新内核版本到4.x以上</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>xdl@client<span class="o">]</span> ~$ uname -r
</span></span><span class="line"><span class="cl">5.10.8-1.el7.elrepo.x86_64
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>安装软件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@client<span class="o">]</span> ~$ yum makecache
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@client<span class="o">]</span> ~$ yum install -y python-setuptools
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@client<span class="o">]</span> ~$ su - ceph
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ sudo yum install -y ceph ceph-radosgw
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ ceph --version
</span></span><span class="line"><span class="cl">ceph version 14.2.16 <span class="o">(</span>762032d6f509d5e7ee7dc008d80fe9c87086603c<span class="o">)</span> nautilus <span class="o">(</span>stable<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在admin节点赋予client使用命令免权限</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@admin cluster<span class="o">]</span>$ ceph-deploy admin client
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>修改client下该文件呢的读权限</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ sudo chmod +r /etc/ceph/ceph.client.admin.keyring
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>修改client 的ceph 配置文件，这一步是解决映射镜像时出错问题</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ sudo vim /etc/ceph/ceph.conf
</span></span><span class="line"><span class="cl"><span class="o">[</span>global<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">rbd_default_features</span> <span class="o">=</span> <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>client 节点创建块设备镜像，单位为MB</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ rbd create foo --size <span class="m">4096</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>client 节点映射镜像到主机</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ sudo rbd map foo --name client.admin
</span></span><span class="line"><span class="cl">/dev/rbd0
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>client 节点格式化块设备</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ sudo mkfs -t ext4 -m <span class="m">0</span> /dev/rbd/rbd/foo
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="8">
<li>client 节点挂载块设备</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ sudo mkdir /mnt/ceph
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ sudo mount /dev/rbd/rbd/foo /mnt/ceph/
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ df -lhT
</span></span><span class="line"><span class="cl">文件系统       类型      容量  已用  可用 已用% 挂载点
</span></span><span class="line"><span class="cl">/dev/rbd0      ext4      3.9G   16M  3.8G    1% /mnt/ceph
</span></span></code></pre></td></tr></table>
</div>
</div><p>客户端重启后，设备需要重新做映射（6），不然会卡死</p>
<ol start="9">
<li>测试</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>ceph@client ~<span class="o">]</span>$ <span class="nb">cd</span> /mnt/ceph/
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@client ceph<span class="o">]</span>$ sudo touch test.txt
</span></span><span class="line"><span class="cl"><span class="o">[</span>ceph@client ceph<span class="o">]</span>$ ls
</span></span><span class="line"><span class="cl">lost+found  test.txt
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>Ceph 分布式文件系统简介</title><link>https://blog.hellolinux.cc/2020/cephfs-info/</link><pubDate>Mon, 17 Aug 2020 17:48:54 +0000</pubDate><author><name>Neal</name><uri>https://blog.hellolinux.cc</uri><email>pengshp3@outlook.com</email></author><guid>https://blog.hellolinux.cc/2020/cephfs-info/</guid><description><![CDATA[<p><figure><a class="lightgallery" href="https://pengshp.coding.net/p/images/d/images/git/raw/master/blog-ceph-intr.jpg" title="blog-ceph-intr" data-thumbnail="https://pengshp.coding.net/p/images/d/images/git/raw/master/blog-ceph-intr.jpg" data-sub-html="<h2>Ceph</h2><p>blog-ceph-intr</p>">
        
    </a><figcaption class="image-caption">Ceph</figcaption>
    </figure></p>
<p>Ceph 是一种使用广泛的分布式文件系统</p>
<h1 id="存储分类" class="headerLink">
    <a href="#%e5%ad%98%e5%82%a8%e5%88%86%e7%b1%bb" class="header-mark"></a>存储分类</h1><h2 id="本地文件系统" class="headerLink">
    <a href="#%e6%9c%ac%e5%9c%b0%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" class="header-mark"></a>1 本地文件系统</h2><p>ntfs(wind)、ext2、ext3、ext4、xfs</p>
<p>ext2不带日志，3和4带有日志：文件系统的日志作用（防止机器突然断电）：所有的数据在给磁盘存数据之前会先给文件系统的日志里面存一份，防止机器突然断电之后数据没有存完，这样它还可以从日志里面重新将数据拷贝到磁盘。</p>
<h2 id="网络文件系统" class="headerLink">
    <a href="#%e7%bd%91%e7%bb%9c%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" class="header-mark"></a>2 网络文件系统</h2><p>nfs           网络文件系统&ndash;称之为nas存储（网络附加存储）</p>
<h2 id="分布式文件系统" class="headerLink">
    <a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" class="header-mark"></a>3 分布式文件系统</h2><ul>
<li>
<p>hdfs          分布式网络文件系统</p>
</li>
<li>
<p>glusterfs     分布式网络文件系统，不需要管理服务器</p>
</li>
<li>
<p>ceph          分布式网络文件系统，块存储，对象存储</p>
</li>
</ul>
<h1 id="分布式文件系统架构" class="headerLink">
    <a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e6%9e%b6%e6%9e%84" class="header-mark"></a>分布式文件系统架构</h1><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">							client
</span></span><span class="line"><span class="cl">                                 <span class="p">|</span>
</span></span><span class="line"><span class="cl">                             namenode   
</span></span><span class="line"><span class="cl">                                 <span class="p">|</span>
</span></span><span class="line"><span class="cl">                 ------------------------------------
</span></span><span class="line"><span class="cl">                 <span class="p">|</span>               <span class="p">|</span>                  <span class="p">|</span>
</span></span><span class="line"><span class="cl">               datanode        datanode            datanode
</span></span></code></pre></td></tr></table>
</div>
</div><p>namenode 元数据服务器-管理服务器，存储这个文件的数据存放的位置信息</p>
<p>datanode 存储数据，数据节点</p>
<h1 id="分布式文件系统的特性" class="headerLink">
    <a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e7%9a%84%e7%89%b9%e6%80%a7" class="header-mark"></a>分布式文件系统的特性</h1><ul>
<li>
<p>可扩展</p>
<p>分布式存储系统可以扩展到几百台甚至几千台的集群规模，而且随着集群规模的增长，系统整体性能表现为线性增长。分布式存储的水平扩展有以下几个特性：</p>
<ol>
<li>
<p>节点扩展后，旧数据会自动迁移到新节点，实现负载均衡，避免单点故障的情况出现;</p>
</li>
<li>
<p>水平扩展只需要将新节点和原有集群连接到同一网络，整个过程不会对业务造成影响;</p>
</li>
</ol>
</li>
<li>
<p>低成本</p>
<p>分布式存储系统的自动容错、自动负载均衡机制使其可以构建在普通的PC机之上。</p>
</li>
<li>
<p>易管理</p>
<p>可通过一个简单的WEB界面就可以对整个系统进行配置管理，运维简便，极低的管理成本。</p>
</li>
</ul>
<h2 id="块存储的特点" class="headerLink">
    <a href="#%e5%9d%97%e5%ad%98%e5%82%a8%e7%9a%84%e7%89%b9%e7%82%b9" class="header-mark"></a>1 块存储的特点：</h2><p>1.主要是将裸磁盘空间映射给主机使用的，共享的最小单位是块</p>
<p>2.使用的交换机是光纤交换机价格贵成本高</p>
<p>3.性能最好，扩展性好</p>
<p>4.不能做文件系统的共享</p>
<p>最典型的就是SAN（storage area network）(存储区域网)&mdash;-有一个局域网里面有一个交换机， 交换机上面连着服务器，所有服务器都是专业存储的设备，他们组成一个存储区域网，当我们用的时候只需要在 这个区域网里面拿空间使用</p>
<h2 id="对象存储" class="headerLink">
    <a href="#%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8" class="header-mark"></a>2 对象存储</h2><h3 id="为什么需要对象存储" class="headerLink">
    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8" class="header-mark"></a>2.1 为什么需要对象存储？</h3><p>首先，一个文件包含了属性（术语叫metadata，元数据，例如该文件的大小、修改时间、存储路径等）以及内容（以下简称数据）。</p>
<p>而对象存储则将元数据独立了出来，控制节点叫元数据服务器（服务器+对象存储管理软件），里面主要负责存储对象的属性（主要是对象的数据被打散存放到了那几台分布式服务器中的信息），而其他负责存储数据的分布式服务器叫做OSD，主要负责存储文件的数据部分。当用户访问对象，会先访问元数据服务器，元数据服务器只负责反馈对象存储在哪些OSD，假设反馈文件A存储在B、C、D三台OSD， 那么用户就会再次直接访问3台OSD服务器去读取数据。</p>
<p>由于是3台OSD同时对外传输数据，所以传输的速度就加快了。当OSD服务器数量越多，这种读写速度的提升就越大，通过此种方式，实现了读写快的目的。</p>
<p>另一方面，对象存储软件是有专门的文件系统的，所以OSD对外又相当于文件服务器，那么就不存在文件共享方面的困难了，也解决了文件共享方面的问题。</p>
<p>#所以对象存储的出现，很好地结合了块存储与文件存储的优点。</p>
<h3 id="优点" class="headerLink">
    <a href="#%e4%bc%98%e7%82%b9" class="header-mark"></a>2.2 优点：</h3><ol>
<li>
<p>具备块存储的读写高速。</p>
</li>
<li>
<p>具备文件存储的共享等特性。</p>
</li>
</ol>
<h3 id="使用场景-适合更新变动较少的数据" class="headerLink">
    <a href="#%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af-%e9%80%82%e5%90%88%e6%9b%b4%e6%96%b0%e5%8f%98%e5%8a%a8%e8%be%83%e5%b0%91%e7%9a%84%e6%95%b0%e6%8d%ae" class="header-mark"></a>2.3 使用场景： (适合更新变动较少的数据)</h3><ol>
<li>
<p>图片存储。</p>
</li>
<li>
<p>视频存储。</p>
</li>
</ol>]]></description></item><item><title>我的 vim 配置文件</title><link>https://blog.hellolinux.cc/2020/my-vimrc-backup/</link><pubDate>Sat, 18 Jul 2020 16:21:51 +0000</pubDate><author><name>Neal</name><uri>https://blog.hellolinux.cc</uri><email>pengshp3@outlook.com</email></author><guid>https://blog.hellolinux.cc/2020/my-vimrc-backup/</guid><description><![CDATA[<p><figure><a class="lightgallery" href="https://pengshp.coding.net/p/images/d/images/git/raw/master/blog-vim.png" title="blog-vim" data-thumbnail="https://pengshp.coding.net/p/images/d/images/git/raw/master/blog-vim.png" data-sub-html="<h2>vim</h2><p>blog-vim</p>">
        
    </a><figcaption class="image-caption">vim</figcaption>
    </figure></p>
<p>我常用到的vim配置文件备份，纯vim配置，不包含任何插件，做一个记录备份，方便多系统迁移使用。</p>
<h2 id="安装vim" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85vim" class="header-mark"></a>1 安装vim</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># CentOS
</span></span><span class="line"><span class="cl">~$ sudo yum install -y vim
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Debian/Ubuntu
</span></span><span class="line"><span class="cl">~$ sudo apt install -y vim
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Arch Linux
</span></span><span class="line"><span class="cl">~$ sudo pacman -Sy vim
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="配置文件" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="header-mark"></a>2 配置文件</h2><p>Debian/Ubuntu 放在<code>/etc/vim/vimrc.local</code>下用于全局配置，对所有用户都生效</p>
<p>放在<code>~/.vimrc</code>只对当前登录用户生效。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">~$ vim ~/.vimrc
</span></span><span class="line"><span class="cl"><span class="s2">&#34;开启语法高亮
</span></span></span><span class="line"><span class="cl"><span class="s2">syntax on
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span> 检测文件类型
</span></span><span class="line"><span class="cl">filetype on
</span></span><span class="line"><span class="cl"><span class="s2">&#34; 设置在Vim中可以使用鼠标，防止终端无法拷贝
</span></span></span><span class="line"><span class="cl"><span class="s2">if has(&#39;mouse&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s2">   set mouse-=a
</span></span></span><span class="line"><span class="cl"><span class="s2">endif
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span> 显示当前行号和列号
</span></span><span class="line"><span class="cl"><span class="nb">set</span> ruler
</span></span><span class="line"><span class="cl"><span class="s2">&#34; 在状态栏显示正在输入的命令
</span></span></span><span class="line"><span class="cl"><span class="s2">set showcmd
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span> 左下角显示当前Vim模式
</span></span><span class="line"><span class="cl"><span class="nb">set</span> showmode
</span></span><span class="line"><span class="cl"><span class="s2">&#34; 括号匹配模式
</span></span></span><span class="line"><span class="cl"><span class="s2">set showmatch
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span> 显示行号
</span></span><span class="line"><span class="cl"><span class="nb">set</span> number
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34; 设置tab宽度
</span></span></span><span class="line"><span class="cl"><span class="s2">set tabstop=4
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span> 设置自动对齐空格数
</span></span><span class="line"><span class="cl"><span class="nb">set</span> <span class="nv">shiftwidth</span><span class="o">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;设置（软）制表符宽度为4
</span></span></span><span class="line"><span class="cl"><span class="s2">set softtabstop=4
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span> 用space替代tab的输入 
</span></span><span class="line"><span class="cl"><span class="nb">set</span> expandtab
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;不用space替代tab的输入
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span> <span class="nb">set</span> noexpandtab
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34; 智能自动缩进
</span></span></span><span class="line"><span class="cl"><span class="s2">set smartindent
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span> 自动对齐
</span></span><span class="line"><span class="cl"><span class="nb">set</span> autoindent
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34; 设置编码方式
</span></span></span><span class="line"><span class="cl"><span class="s2">set encoding=utf-8
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">set helplang=cn
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">set magic
</span></span></span><span class="line"><span class="cl"><span class="s2">set cursorline
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span> 搜索相关
</span></span><span class="line"><span class="cl"><span class="nb">set</span> hlsearch
</span></span><span class="line"><span class="cl"><span class="nb">set</span> incsearch
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;不要备份文件
</span></span></span><span class="line"><span class="cl"><span class="s2">set nobackup
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="参考链接" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="header-mark"></a>2.1 参考链接</h3><p>1.<a href="https://vimjc.com/" target="_blank" rel="noopener noreffer">vim教程网</a></p>
<p>2.<a href="https://www.vim.org/" target="_blank" rel="noopener noreffer">vim官网</a></p>]]></description></item></channel></rss>